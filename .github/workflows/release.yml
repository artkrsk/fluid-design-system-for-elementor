name: Release Plugin

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: read

jobs:
  # Extract changelog from readme.txt
  prepare-changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.extract.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract changelog from readme.txt
        id: extract
        run: |
          CHANGELOG=$(node scripts/extract-changelog.js latest)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Create release using reusable workflow with custom changelog
  release:
    needs: prepare-changelog
    uses: artkrsk/wordpress-plugin-release-action/.github/workflows/release.yml@main
    with:
      # Build configuration
      node_version: '23'
      build_command: 'composer --version && npm run build'

      # Changelog from readme.txt
      custom_changelog: ${{ needs.prepare-changelog.outputs.changelog }}

      # Paths
      assets_directory: '__assets__'

      # Version validation
      version_files: '["plugin_header", "readme.txt", "package.json"]'

      # WordPress.org deployment
      deploy_to_wordpress: true

    secrets:
      SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
      SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
