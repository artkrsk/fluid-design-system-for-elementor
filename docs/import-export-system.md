# Fluid Design System Import/Export - Technical Specification

> **Related Documentation**: [Build System & React Migration](./build-system-react-migration.md)

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Vision & Goals](#vision--goals)
3. [Research Findings](#research-findings)
4. [Current System Analysis](#current-system-analysis)
5. [Proposed Architecture](#proposed-architecture)
6. [Technical Challenges & Solutions](#technical-challenges--solutions)
7. [Implementation Plan](#implementation-plan)
8. [API Reference](#api-reference)

---

## Executive Summary

### Project Overview

The Fluid Design System for Elementor currently exports/imports its presets as part of Elementor's complete kit export system. This project aims to create a **surgical import/export system** that:

- Exports ONLY fluid design presets and settings
- Imports ONLY fluid design settings without affecting other kit settings
- Maintains 100% compatibility with Elementor's JSON schema
- Provides granular control over merge strategies

### Key Innovation

Using Elementor's exact JSON format for maximum compatibility while providing surgical precision in what gets imported/exported.

---

## Vision & Goals

### Primary Goals

1. **Surgical Precision**: Import/export ONLY fluid-related settings
2. **Format Compatibility**: Use Elementor's native JSON schema
3. **Safe Merging**: Multiple strategies to prevent breaking existing designs
4. **User Control**: Preview and options before import
5. **Preservation**: Never break existing typography references

### Use Cases

- **Design System Sharing**: Share fluid presets between projects
- **Team Collaboration**: Distribute standardized spacing/typography scales
- **Backup/Restore**: Save fluid settings independently
- **Template Libraries**: Include fluid presets with theme packages

---

## Research Findings

### Elementor Kit Import/Export System

#### Entry Points

```
app/modules/import-export/module.php
├── Import class instantiation
├── Runner registration
├── Manifest processing
└── Kit creation via kits_manager
```

#### Import Process Flow

1. **ZIP Extraction**: Extract uploaded kit file
2. **Manifest Reading**: Parse `manifest.json` and `site-settings.json`
3. **Runner Execution**: Sequential execution of import runners
4. **Kit Creation**: `Plugin::$instance->kits_manager->create_new_kit()`
5. **Settings Storage**: Kit settings saved to `wp_postmeta` as `_elementor_page_settings`
6. **Cache Clear**: Elementor cache refresh

#### Data Storage

- **Table**: `wp_posts` (post_type: 'elementor_library')
- **Meta Key**: `_elementor_page_settings` (serialized array)
- **Options**:
  - `elementor_active_kit` - Current active kit ID
  - `elementor_previous_kit` - Previous kit ID for rollback

### Elementor Site Settings JSON Structure

Actual export format from `/Users/art/Local Sites/dev/app/public/wp-content/site-settings.json`:

```json
{
  "settings": {
    // Breakpoints
    "min_screen_width": 360,
    "max_screen_width": 1920,

    // Built-in fluid presets
    "fluid_spacing_presets": [
      {
        "_id": "3173179",
        "title": "XXSmall",
        "popover_toggle": "yes",
        "min": {"unit": "px", "size": 20, "sizes": []},
        "max": {"unit": "px", "size": 30, "sizes": []}
      }
    ],
    "fluid_typography_presets": [...],

    // Custom group presets (dynamic keys)
    "fluid_custom_borderradius_1757320189_presets": [...],
    "fluid_custom_gaps_1757246348_presets": [...],

    // Typography using fluid presets
    "custom_typography": [
      {
        "_id": "34cae0e",
        "title": "Paragraph",
        "typography_font_size": {
          "unit": "fluid",
          "size": "var(--arts-fluid-preset--bfc5ad9)",
          "sizes": []
        }
      }
    ]
  },
  "metadata": [...],
  "theme": {...}
}
```

---

## Current System Analysis

### Fluid Preset ID System

#### ID Generation & Usage

1. **Preset ID**: Unique identifier generated by Elementor (e.g., `bfc5ad9`)
2. **CSS Variable**: Created as `--arts-fluid-preset--{_id}`
3. **Reference**: Used in typography as `var(--arts-fluid-preset--bfc5ad9)`

#### Code Implementation

From `src/php/Elementor/Tabs/FluidTypographySpacing.php:360`:

```php
'selectors' => array(
    ':root' => CSSVariables::get_css_var_preset( '{{_id.VALUE}}' ) . ': ' .
               CSSVariables::get_clamp_formula( 'min', 'max' ) . ';',
)
```

From `src/php/Managers/CSSVariables.php`:

```php
const CSS_VAR_PRESET_PREFIX = '--arts-fluid-preset--';

public static function get_css_var_preset( $id ) {
    return self::CSS_VAR_PRESET_PREFIX . $id;
}
```

### Custom Groups System

#### Storage Structure

- **Option Name**: `arts_fluid_design_system_custom_groups`
- **Group ID Format**: `{name}_{timestamp}` (e.g., `borderradius_1757320189`)
- **Preset Key**: `fluid_custom_{group_id}_presets`

#### Group Management

From `src/php/Managers/Data.php`:

- Groups stored in WordPress options
- Order tracking for drag-and-drop interface
- Main group order stored separately

### Control ID Management (ControlRegistry)

**IMPORTANT**: All control ID generation and parsing should be done through `src/php/Managers/ControlRegistry.php` to ensure consistency across the codebase.

#### ControlRegistry Purpose

The `ControlRegistry` class is the single source of truth for:

- Generating control IDs for custom groups
- Parsing control IDs to extract group information
- Managing prefixes (`fluid_custom_`, `_presets` suffixes)
- Validating control ID formats
- Mapping between group IDs and control IDs

#### Key Methods

```php
// Generate control ID for custom group
ControlRegistry::get_custom_group_control_id($group_id)
// Returns: 'fluid_custom_{group_id}_presets'

// Parse control ID to get group info
ControlRegistry::parse_control_id($control_id)
// Returns: ['type' => 'custom', 'group_id' => 'borderradius_1757320189']

// Generate control ID with type detection
ControlRegistry::generate_control_id($group_id, $type)
// Handles both builtin and custom groups

// Validate control ID format
ControlRegistry::is_valid_control_id($control_id)
// Returns: boolean
```

#### Files Using ControlRegistry

- `Plugin.php` - Registers as a manager
- `Managers/GroupsData.php` - Gets control mappings and IDs
- `Managers/Admin/Frontend.php` - Generates control IDs for admin UI
- `Elementor/Units/Fluid/Module.php` - Gets metadata and control IDs
- `Elementor/Tabs/FluidTypographySpacing.php` - Creates sections and controls

#### Control ID Patterns

```php
// Built-in groups
'fluid_spacing_presets'
'fluid_typography_presets'

// Custom groups
'fluid_custom_{group_id}_presets'
// Example: 'fluid_custom_borderradius_1757320189_presets'
```

---

## Proposed Architecture

### Export System

#### Data Structure (Elementor-Compatible)

```json
{
  "settings": {
    // Core breakpoints
    "min_screen_width": 360,
    "max_screen_width": 1920,

    // Built-in presets
    "fluid_spacing_presets": [...],
    "fluid_typography_presets": [...],

    // Custom group presets (dynamic)
    "fluid_custom_[group_id]_presets": [...]
  },
  "metadata": {
    // Fluid-specific metadata
    "export_type": "fluid_design_system",
    "version": "1.1.0",
    "export_date": "2025-01-17T12:00:00Z",
    "custom_groups": {
      "group_id": {
        "name": "Group Name",
        "description": "Description",
        "order": 1
      }
    },
    "main_group_order": ["fluid_spacing_presets", "fluid_typography_presets", "custom_group_id"]
  }
}
```

#### Export Process

1. Extract fluid settings from active kit
2. Include custom group metadata
3. Optionally include dependent typography settings
4. Generate JSON in Elementor format

### Import System

#### Detection Logic

```php
use \Arts\FluidDesignSystem\Managers\ControlRegistry;

// Detect import type
$is_full_kit = isset($data['content']) || isset($data['templates']);
$is_fluid_export = isset($data['metadata']['export_type']) &&
                   $data['metadata']['export_type'] === 'fluid_design_system';

// Extract fluid keys using ControlRegistry for validation
$fluid_keys = array_filter(array_keys($data['settings']), function($key) {
    // Use ControlRegistry to validate control IDs
    if (ControlRegistry::is_valid_control_id($key)) {
        return true;
    }
    // Also include breakpoint settings
    return in_array($key, ['min_screen_width', 'max_screen_width']);
});
```

#### Surgical Update Process

1. **Parse JSON**: Validate structure and version
2. **Extract Fluid Settings**: Filter only fluid-related keys
3. **Process Groups**: Handle custom group creation/updates
4. **Merge Presets**: Apply selected merge strategy
5. **Update Kit**: Surgically update only fluid settings
6. **Clear Cache**: Refresh Elementor cache

---

## Technical Challenges & Solutions

### Challenge 1: Preset ID Conflicts

#### Problem

Importing presets with same `_id` overwrites CSS variables, breaking existing designs.

#### Solution: Smart ID Management

```php
class PresetIdManager {
    /**
     * Strategy 1: Preserve by Title
     * Keep existing ID if titles match
     */
    private function preserveByTitle($imported, $existing) {
        foreach ($imported as &$preset) {
            $match = $this->findByTitle($preset['title'], $existing);
            if ($match) {
                $preset['_id'] = $match['_id'];
            }
        }
        return $imported;
    }

    /**
     * Strategy 2: Generate New IDs
     * Create new IDs for all imported presets
     */
    private function regenerateIds($imported) {
        $idMap = [];
        foreach ($imported as &$preset) {
            $oldId = $preset['_id'];
            $newId = $this->generateUniqueId();
            $preset['_id'] = $newId;
            $idMap[$oldId] = $newId;
        }
        return [$imported, $idMap];
    }
}
```

### Challenge 2: Typography References

#### Problem

Typography settings reference presets via `var(--arts-fluid-preset--id)`. Changing IDs breaks these references.

#### Solution: Reference Remapping

```php
class ReferenceRemapper {
    /**
     * Update typography references after ID changes
     */
    public function remapReferences($settings, $idMap) {
        $pattern = '/var\(--arts-fluid-preset--([a-f0-9]+)\)/';

        foreach ($settings['custom_typography'] as &$typo) {
            if (isset($typo['typography_font_size']['size'])) {
                $size = $typo['typography_font_size']['size'];
                if (preg_match($pattern, $size, $matches)) {
                    $oldId = $matches[1];
                    if (isset($idMap[$oldId])) {
                        $typo['typography_font_size']['size'] =
                            "var(--arts-fluid-preset--{$idMap[$oldId]})";
                    }
                }
            }
        }

        return $settings;
    }
}
```

### Challenge 3: Custom Group Conflicts

#### Problem

Custom groups use timestamp-based IDs that might conflict.

#### Solution: Dynamic Group ID Generation Using ControlRegistry

```php
class CustomGroupManager {
    /**
     * Import groups with new timestamp IDs
     * MUST use ControlRegistry for ID generation
     */
    public function importGroups($importedSettings, $metadata) {
        use \Arts\FluidDesignSystem\Managers\ControlRegistry;

        $groupMapping = [];

        foreach ($importedSettings as $key => $presets) {
            // Use ControlRegistry to parse the control ID
            $parsed = ControlRegistry::parse_control_id($key);

            if ($parsed && $parsed['type'] === 'custom') {
                $oldGroupId = $parsed['group_id'];

                // Extract base name (remove timestamp)
                preg_match('/(.+)_(\d+)$/', $oldGroupId, $matches);
                $baseName = $matches[1] ?? $oldGroupId;

                // Generate new group with timestamp
                $newGroupId = $baseName . '_' . time();

                // Use ControlRegistry to generate proper control ID
                $newControlId = ControlRegistry::get_custom_group_control_id($newGroupId);

                // Map old to new
                $groupMapping[$key] = $newControlId;

                // Create group in Data manager
                $this->createGroup($newGroupId, $metadata[$oldGroupId] ?? []);
            }
        }

        return $groupMapping;
    }
}
```

---

## Implementation Plan

> **Prerequisites**: This implementation requires the [Build System & React Migration](./build-system-react-migration.md) to be completed first (Weeks 1-3).

### Phase 1: Core Infrastructure (Week 4 of overall project)

#### Backend File Structure

```
src/php/Managers/ImportExport/
├── Module.php              # Main module registration
├── Export.php              # Export logic
├── Import.php              # Import logic
├── RestController.php      # REST API endpoints
├── Strategies/
│   ├── MergeStrategy.php   # Base merge strategy
│   ├── SmartMerge.php      # Smart merge implementation
│   ├── Replace.php         # Replace all strategy
│   └── Append.php          # Append only strategy
├── Validators/
│   ├── JsonValidator.php   # JSON structure validation
│   └── PresetValidator.php # Preset data validation
└── Utils/
    ├── IdManager.php       # ID generation and mapping
    └── ReferenceMapper.php # Reference updating
```

#### React Frontend Structure (Following new architecture)

```
src/js/admin/components/ImportExport/
├── index.jsx               # Main component
├── ExportPanel.jsx         # Export interface
├── ImportPanel.jsx         # Import interface
├── ConflictResolver/
│   ├── index.jsx          # Conflict resolution modal
│   ├── ConflictItem.jsx   # Individual conflict
│   ├── PresetComparison.jsx # Visual comparison
│   └── ResolutionOptions.jsx # Resolution choices
├── Preview/
│   ├── ImportPreview.jsx  # Import preview
│   └── PresetViewer.jsx   # Preset visualization
└── hooks/
    ├── useImport.js       # Import logic hook
    └── useExport.js       # Export logic hook

src/styles/admin/components/
├── _import-export.scss    # Main styles
├── _conflict-resolver.scss # Conflict UI styles
└── _preview.scss          # Preview styles
```

### Phase 2: Export Functionality (Week 5 of overall project)

> **Note**: Builds on React foundation from Week 3-4

#### Tasks

1. Create export data extractor (PHP)
2. Build JSON formatter
3. Implement REST API endpoints
4. Create React ExportPanel component
5. Add selective export options
6. Implement download handler

#### Code Components

```php
// src/php/Managers/ImportExport/Export.php
class Export {
    public function export($options = []) {
        use \Arts\FluidDesignSystem\Managers\ControlRegistry;
        use \Arts\FluidDesignSystem\Managers\Data;

        $kit = Plugin::$instance->kits_manager->get_active_kit();
        $settings = $kit->get_settings();

        // Build list of fluid keys to export
        $fluid_keys = ['min_screen_width', 'max_screen_width'];

        // Add built-in presets
        $fluid_keys[] = 'fluid_spacing_presets';
        $fluid_keys[] = 'fluid_typography_presets';

        // Add custom group presets using ControlRegistry
        $custom_groups = Data::get_custom_groups();
        foreach ($custom_groups as $group_id => $group) {
            $control_id = ControlRegistry::get_custom_group_control_id($group_id);
            $fluid_keys[] = $control_id;
        }

        $exportData = [
            'settings' => array_intersect_key($settings, array_flip($fluid_keys)),
            'metadata' => $this->generateMetadata()
        ];

        return json_encode($exportData, JSON_PRETTY_PRINT);
    }
}
```

### Phase 3: Import/Export Implementation (Week 6 of overall project)

> **Prerequisites**: Requires React foundation from Weeks 3-5 to be complete

#### Backend Tasks

1. Create import parser (PHP)
2. Implement merge strategies
3. Build conflict detection system
4. Create REST API endpoints
5. Add validation layers

#### Frontend Tasks (React)

1. Build ImportExport main component
2. Create ExportPanel with options
3. Implement ImportPanel with file upload
4. Build ConflictResolver component
5. Add visual preview system
6. Connect to WordPress Data stores

#### Merge Strategies

##### Smart Merge (Default)

- Match presets by title
- Update values for matches
- Add new presets with new IDs
- Preserve all references

##### Replace All

- Clear existing presets
- Import all new presets
- Update typography references
- High risk, requires confirmation

##### Append Only

- Keep all existing presets
- Add only new presets
- Generate new IDs for all imported
- Safest option

### Phase 4: React UI Components

> **Note**: UI components are built with React as described in [Build System & React Migration](./build-system-react-migration.md#react-migration-architecture)

#### Key React Components

**ExportPanel Component**

- WordPress Components: `Card`, `CheckboxControl`, `Button`
- Custom hooks: `useExport` for export logic
- State management via WordPress Data

**ImportPanel Component**

- File upload with drag & drop
- Real-time validation feedback
- Preview before import

**ConflictResolver Component**

- Modal-based interface
- Side-by-side comparison
- Visual diff for presets
- Bulk resolution options

See full React component implementations in the [Build System documentation](./build-system-react-migration.md#react-driven-ui-implementation)

### Phase 5: Testing & Polish (End of Week 6)

#### Test Scenarios

1. **Import from full kit**: Extract fluid settings from complete export
2. **Import fluid-only**: Import dedicated fluid export
3. **ID conflict resolution**: Test all conflict scenarios
4. **Typography preservation**: Verify references remain intact
5. **Custom group handling**: Test group creation and merging
6. **Edge cases**: Empty presets, malformed JSON, version mismatches

#### Validation Checklist

- [ ] JSON structure validation
- [ ] Preset data integrity
- [ ] ID uniqueness
- [ ] Reference mapping accuracy
- [ ] Custom group creation
- [ ] Backup functionality
- [ ] Error handling
- [ ] User feedback messages

---

## API Reference

### PHP Classes

#### ControlRegistry Class (Required for ID Management)

```php
namespace Arts\FluidDesignSystem\Managers;

/**
 * CRITICAL: All import/export operations MUST use ControlRegistry
 * for control ID generation and parsing to ensure consistency.
 */
class ControlRegistry {
    /**
     * Get control ID for custom group presets
     *
     * @param string $group_id The custom group ID
     * @return string The control ID (fluid_custom_{group_id}_presets)
     */
    public static function get_custom_group_control_id(string $group_id): string;

    /**
     * Parse control ID to extract group information
     *
     * @param string $control_id The control ID to parse
     * @return array|false ['type' => 'custom'|'builtin', 'group_id' => string]
     */
    public static function parse_control_id(string $control_id);

    /**
     * Validate control ID format
     *
     * @param string $control_id The control ID to validate
     * @return bool True if valid fluid control ID
     */
    public static function is_valid_control_id(string $control_id): bool;

    /**
     * Generate control ID from group ID with type detection
     *
     * @param string $group_id The group ID
     * @param string $type Optional type ('builtin' or 'custom')
     * @return string The properly formatted control ID
     */
    public static function generate_control_id(string $group_id, string $type = null): string;
}
```

#### Export Class

```php
namespace Arts\FluidDesignSystem\Managers\ImportExport;

class Export {
    /**
     * Export fluid settings
     * MUST use ControlRegistry for control ID generation
     *
     * @param array $options Export options
     * @return string JSON string
     */
    public function export(array $options = []): string;

    /**
     * Extract fluid settings from kit
     *
     * @param array $settings Kit settings
     * @param array $options Filter options
     * @return array Filtered settings
     */
    private function extractFluidSettings(array $settings, array $options): array;
}
```

#### Import Class

```php
namespace Arts\FluidDesignSystem\Managers\ImportExport;

class Import {
    /**
     * Import fluid settings
     * MUST use ControlRegistry for control ID validation and generation
     *
     * @param string $json JSON data
     * @param array $options Import options
     * @return array Import result
     */
    public function import(string $json, array $options = []): array;

    /**
     * Preview import without applying
     *
     * @param string $json JSON data
     * @return array Preview data
     */
    public function preview(string $json): array;
}
```

### AJAX Endpoints

#### Export Endpoint

```
Action: wp_ajax_arts_fds_export_settings
Nonce: arts_fds_export
Parameters:
  - options[include_breakpoints]: boolean
  - options[groups]: array of group IDs
Response:
  - success: boolean
  - data[filename]: string
  - data[content]: JSON string
```

#### Import Endpoint

```
Action: wp_ajax_arts_fds_import_settings
Nonce: arts_fds_import
Parameters:
  - file: uploaded file
  - options[strategy]: 'smart'|'replace'|'append'
  - options[backup]: boolean
Response:
  - success: boolean
  - data[imported]: count of imported presets
  - data[updated]: count of updated presets
```

### JavaScript API

#### ImportExport Manager

```javascript
class ImportExportManager {
    /**
     * Initialize import/export functionality
     */
    constructor();

    /**
     * Export settings
     * @param {Object} options Export options
     * @returns {Promise<Blob>} Export file
     */
    async export(options);

    /**
     * Import settings
     * @param {File} file Import file
     * @param {Object} options Import options
     * @returns {Promise<Object>} Import result
     */
    async import(file, options);

    /**
     * Preview import
     * @param {File} file Import file
     * @returns {Promise<Object>} Preview data
     */
    async preview(file);
}
```

### Hooks & Filters

#### PHP Hooks

```php
// Before export
do_action('arts/fluid_design_system/before_export', $data);

// Filter export data
apply_filters('arts/fluid_design_system/export_data', $data);

// Before import
do_action('arts/fluid_design_system/before_import', $data);

// Filter import data
apply_filters('arts/fluid_design_system/import_data', $data);

// Import conflicts
apply_filters('arts/fluid_design_system/import_conflicts', $conflicts, $existing, $imported);

// After import success
do_action('arts/fluid_design_system/after_import', $result);
```

#### JavaScript Events

```javascript
// Export started
jQuery(document).trigger('fds:export:start', [options])

// Export completed
jQuery(document).trigger('fds:export:complete', [data])

// Import preview ready
jQuery(document).trigger('fds:import:preview', [preview])

// Import completed
jQuery(document).trigger('fds:import:complete', [result])
```

---

## Appendix

### A. Elementor Kit Structure Reference

#### Complete Kit Export Structure

```
kit.zip
├── manifest.json          # Kit manifest
├── site-settings.json     # All kit settings (including fluid)
├── templates/            # Elementor templates
├── content/              # WordPress content
└── wp-content/           # Media and other assets
```

#### Minimal Fluid Export Structure

```json
{
  "settings": {
    // Only fluid-related keys
  },
  "metadata": {
    "export_type": "fluid_design_system"
  }
}
```

### B. CSS Variable Reference

#### Generated CSS Structure

```css
:root {
  /* Breakpoints */
  --arts-fluid-min-screen: 360px;
  --arts-fluid-max-screen: 1920px;
  --arts-fluid-screen-diff: calc(
    var(--arts-fluid-max-screen-value) - var(--arts-fluid-min-screen-value)
  );

  /* Preset Variables */
  --arts-fluid-preset--bfc5ad9: clamp(
    16px,
    calc(
      16px + (16 - 16) * ((100vw - var(--arts-fluid-min-screen)) / var(--arts-fluid-screen-diff))
    ),
    16px
  );
  --arts-fluid-preset--467728a: clamp(
    18px,
    calc(
      18px + (22 - 18) * ((100vw - var(--arts-fluid-min-screen)) / var(--arts-fluid-screen-diff))
    ),
    22px
  );
}
```

### C. Database Schema

#### WordPress Options

```sql
-- Custom groups storage
option_name: 'arts_fluid_design_system_custom_groups'
option_value: serialized array

-- Main group order
option_name: 'arts_fluid_design_system_main_group_order'
option_value: serialized array
```

#### Kit Storage

```sql
-- Kit post
wp_posts:
  post_type: 'elementor_library'
  post_status: 'publish'

-- Kit settings
wp_postmeta:
  meta_key: '_elementor_page_settings'
  meta_value: serialized array containing all kit settings
```

---

## Integration with Build System & React Migration

This Import/Export system is designed to be implemented as part of the larger [Build System & React Migration](./build-system-react-migration.md) project. The implementation timeline assumes:

### Prerequisites (Weeks 1-5)

1. **Weeks 1-2**: Build system with multi-entry support
2. **Week 3**: React foundation and WordPress integration
3. **Weeks 4-5**: Group Management migration to React

### Implementation (Week 6)

The Import/Export system will be built entirely in React from the start, serving as:

- Proof of concept for the React architecture
- Showcase of advanced React patterns (conflict resolution, visual diff)
- Integration example with WordPress Data stores

### Key Dependencies

- **Build System**: Multi-entry configuration for admin bundle
- **React Foundation**: WordPress Components and Data stores
- **REST API**: New endpoints for import/export operations
- **ControlRegistry**: Centralized control ID management

### File Locations

All Import/Export code follows the new structure:

- **Backend**: `src/php/Managers/ImportExport/`
- **Frontend**: `src/js/admin/components/ImportExport/`
- **Styles**: `src/styles/admin/components/`
- **Build Output**: `src/php/libraries/admin/`

---

_Document Version: 1.1_
_Last Updated: January 2025_
_Author: Fluid Design System Development Team_
_Related Documents: [Build System & React Migration](./build-system-react-migration.md)_
